<!-- templates/cart/cart_detail.html -->
{% extends "base.html" %}
{% load cart_extras %}

{% block content %}
<a href="{% url 'Ecommerce_products:product_list' %}">Product List</a>
<h2>Your Cart</h2>
{% if cart and cart.items.count > 0 %}
<ul>
    {% for item in cart.items.all %}
    <li>{{ item.product.name }} (x{{ item.quantity }}) - ${{ item.get_total_price }}
        <a href="{% url 'Ecommerce_cart:remove_from_cart' item.id %}">Remove</a>
    </li>
    {% endfor %}
</ul>
<p>Total: ${{ cart.items.all|cart_total_price }}</p>

<button id="checkout-button">Checkout</button>

<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('{{ stripe_public_key }}');
    document.querySelector("#checkout-button").addEventListener("click", function () {
        fetch("{% url 'Ecommerce_cart:create_checkout_session' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
        })
            .then((response) => response.json())
            .then((session) => {
                return stripe.redirectToCheckout({ sessionId: session.id });
            })
            .then((result) => {
                if (result.error) {
                    alert(result.error.message);
                }
            })
            .catch((error) => {
                console.error("Error:", error);
            });
    });
</script>

{% else %}
<p>Your cart is empty.</p>
{% endif %}
{% endblock %}